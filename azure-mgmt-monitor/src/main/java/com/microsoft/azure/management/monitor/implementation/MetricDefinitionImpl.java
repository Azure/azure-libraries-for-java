/**
 * Copyright (c) Microsoft Corporation. All rights reserved.
 * Licensed under the MIT License. See License.txt in the project root for
 * license information.
 *
 * Code generated by Microsoft (R) AutoRest Code Generator.
 */

package com.microsoft.azure.management.monitor.implementation;
import com.microsoft.azure.management.apigeneration.LangDefinition;
import com.microsoft.azure.management.apigeneration.LangMethodDefinition;
import com.microsoft.azure.management.monitor.AggregationType;
import com.microsoft.azure.management.monitor.LocalizableString;
import com.microsoft.azure.management.monitor.MetricAvailability;
import com.microsoft.azure.management.monitor.MetricCollection;
import com.microsoft.azure.management.monitor.MetricDefinition;
import com.microsoft.azure.management.monitor.ResultType;
import com.microsoft.azure.management.monitor.Unit;
import org.joda.time.DateTime;
import org.joda.time.Period;
import rx.Observable;
import org.joda.time.DateTimeZone;
import org.joda.time.format.ISODateTimeFormat;
import rx.functions.Func1;

import java.util.List;

/**
 * The Azure metric definition entries are of type MetricDefinition.
 */
@LangDefinition(ContainerName = "/Microsoft.Azure.Management.Monitor.Fluent.Models")
class MetricDefinitionImpl
            implements
                MetricDefinition,
                MetricDefinition.Definition {

    private final MonitorManager myManager;
    private MetricDefinitionInner inner;
    private LocalizableString name;
    private DateTime queryStartTime;
    private DateTime queryEndTime;
    private String aggreagation;
    private Period interval;
    private String odataFilter;
    private ResultType resultType;
    private Double top;
    private String orderBy;

    public MetricDefinitionImpl(final MetricDefinitionInner innerModel, final MonitorManager monitorManager) {
        this.myManager = monitorManager;
        this.inner = innerModel;
        this.name = new LocalizableString(inner.name());
    }

    @LangMethodDefinition(AsType = LangMethodDefinition.LangMethodType.Property)
    public String resourceId() {
        return this.inner.resourceId();
    }

    @LangMethodDefinition(AsType = LangMethodDefinition.LangMethodType.Property)
    public LocalizableString name() {
        return this.name;
    }

    @LangMethodDefinition(AsType = LangMethodDefinition.LangMethodType.Property)
    public Unit unit() {
        return this.inner.unit();
    }

    @LangMethodDefinition(AsType = LangMethodDefinition.LangMethodType.Property)
    public AggregationType primaryAggregationType() {
        return this.inner.primaryAggregationType();
    }

    @LangMethodDefinition(AsType = LangMethodDefinition.LangMethodType.Property)
    public List<MetricAvailability> metricAvailabilities() {
        return this.inner.metricAvailabilities();
    }

    @LangMethodDefinition(AsType = LangMethodDefinition.LangMethodType.Property)
    public String id() {
        return this.inner.id();
    }

    @Override
    public FilterDefinitionStages.WithStartTimeFilter defineQuery() {
        this.aggreagation = null;
        this.interval = null;
        this.resultType = null;
        this.top = null;
        this.orderBy = null;
        return this;
    }

    @Override
    public FilterDefinitionStages.WithEndFilter withStartTime(DateTime startTime) {
        this.queryStartTime = startTime;
        return this;
    }

    @Override
    public FilterDefinitionStages.WithExecute withEndTime(DateTime endTime) {
        this.queryEndTime = endTime;
        return this;
    }

    @Override
    public FilterDefinitionStages.WithExecute withAggregation(String aggregation) {
        this.aggreagation = aggregation;
        return this;
    }

    @Override
    public FilterDefinitionStages.WithExecute withInterval(Period interval) {
        this.interval = interval;
        return this;
    }

    @Override
    public FilterDefinitionStages.WithExecute withOdataFilter(String odataFilter) {
        this.odataFilter = odataFilter;
        return this;
    }

    @Override
    public FilterDefinitionStages.WithExecute withResultType(ResultType resultType) {
        this.resultType = resultType;
        return this;
    }

    @Override
    public FilterDefinitionStages.WithExecute selectTop(double top) {
        this.top = top;
        return this;
    }

    @Override
    public FilterDefinitionStages.WithExecute orderBy(String orderBy) {
        this.orderBy = orderBy;
        return this;
    }

    @Override
    public MetricCollection execute() {
        return this.executeAsync().toBlocking().last();
    }

    @Override
    public Observable<MetricCollection> executeAsync() {
        return this.myManager.inner().metrics().listAsync(this.inner.resourceId(),
                String.format("%s/%s",
                        this.queryStartTime.withZone(DateTimeZone.UTC).toString(ISODateTimeFormat.dateTime()),
                        this.queryEndTime.withZone(DateTimeZone.UTC).toString(ISODateTimeFormat.dateTime())),
                this.interval,
                this.inner.name().value(),
                this.aggreagation,
                this.top,
                this.orderBy,
                this.odataFilter,
                this.resultType).map(new Func1<ResponseInner, MetricCollection>() {
                    @Override
                    public MetricCollection call(ResponseInner responseInner) {
                        return new MetricCollection(responseInner);
                    }
                });
    }
}
